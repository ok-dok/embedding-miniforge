## Python程序内置执行环境方案

### 亟需解决的痛点

很多情况下，我们使用python编写程序后，交由用户来执行使用，但是用户环境是十分复杂和不确定的，用户有没有装python，装的python版本符不符合我们程序的要求，即使python版本符合要求但有没有装依赖库，这些问题都会成为阻碍程序成功运行的绊脚石。

对于程序猿来说，安装个python环境并不复杂，但是依然要根据程序要求来安装符合要求的版本是件相对麻烦的事情，这其中不乏很多管理工具来辅助安装，但依然在以下两大方面的依然存在问题：

1. Python本身安装
2. 程序依赖库安装



对于Python本身的安装，我们有以下几种可以考虑的方案：

1. virtualenv: 一种用于管理虚拟Python环境的工具，专注于Python解释器虚拟环境的创建；它可以在项目下创建名为venv的目录，来隔绝全局的python环境，但是它存在两个问题：①只能创建跟全局环境已安装的同样的版本，②3.4版本之前，virtualenv需要手动安装，3.4以后python内置venv库可以代替；virtualenv 主要是用来管理相同版本 Python 不同项目的包的依赖不同的问题，这种方式不能解决程序要求的版本和用户安装版本存在差异不满足执行要求的问题，因此放弃。

2. pipenv: pip+virtualenv的结合体，其本身的安装依赖于现有python环境和pip命令，除了virtualenv的功能外，pipenv只是将导入依赖包的操作简化，不必过多考虑pip install -r requirements.txt安装的问题，无法实现版本管理；

3. pyenv：一种Python版本管理工具，它可以通过修改系统环境变量来实现全局环境的Python版本切换；这似乎是一种能够很好的用来适配项目程序的方式；但是pyenv需要依赖编译类库工具和git命令，需要使用系统的包管理工具来进行安装；

4. anaconda、miniconda：这类集成的数据科学环境，它不仅可以管理Python依赖库的包，还可以对Python本身的执行环境进行管理；与pyenv类似，这似乎是一个很好的Python环境管理方式；

   

从上面几种方案来看，anaconda是比较适合的一种方式，相对于更加适合新手小白的anaconda，miniconda更适合用在程序中为用户安装Python环境；但并不是非常适合程序的简单运行，因为除了涉及到conda程序的安装之外，还会对用户现有环境造成干扰（上面4中方式都会有此问题）。



### 方案思路

#### 1. 检查当前系统python环境是否满足要求

首先检查系统python环境是否满足现有程序要求，如满足不需要进行后续动作。

#### 2. 不满足要求时如何利用当前系统python环境（某些场景下要求不能安装新环境，比如现网服务器、客户现有环境）

这种场景要求程序能够兼容python各版本的语法，能够应对多种不同的python版本环境，对于依赖库的额外安装另需特别考虑。

#### 3. 安装新环境（尽量不污染原有环境）

对于未安装python环境的系统，首先要探测系统信息，包括：

1. 系统类型，区分为win、macOS、linux
2. 系统架构，区分为x86_64/amd64, arm64/aarch64等；

根据系统类型，区分对待：

- 对于macos/linux系统，直接下载最新（或指定版本）miniconda执行安装，然后通过conda来创建环境或者使用conda默认带的python环境创建venv（3.4版本以后可使用python -m venv）

- 对于windows系统，直接下载安装embed版本的python，并通过get-pip.py来安装pip工具（如有需要）
